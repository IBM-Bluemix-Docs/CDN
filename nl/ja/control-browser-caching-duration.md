---

copyright:
  years: 2017, 2018
lastupdated: "2018-08-30"

---

{:shortdesc: .shortdesc}
{:new_window: target="_blank"}
{:codeblock: .codeblock}
{:pre: .pre}
{:screen: .screen}
{:tip: .tip}
{:download: .download}

# キャッシュ制御 `max-age` を使用したブラウザー・キャッシング期間の制御

CDN を使用する場合、キャッシングが可能な場所ごとに 1 つのタイプのキャッシングが存在します。
  * **ブラウザー・レベルのキャッシング**: ブラウザーが特定の期間、コンテンツをキャッシュに入れる場合に発生します。
  * **エッジ・レベルのキャッシング**: CDN エッジ・サーバーが特定の期間 (ただし、必ずしも同期間とは限りません)、オリジンからのコンテンツをキャッシュに入れる場合に発生します。

ブラウザー・レベルでコンテンツをキャッシュに入れておく期間を制御する方法はいくつかあります。 使用する方式は、以下の要素によって決まります。
  * 「ヘッダーを尊重 (Respect Header): On」を使用して、[CDN の構成詳細を更新する](https://console.bluemix.net/docs/infrastructure/CDN/how-to.html#updating-cdn-configuration-details) (または更新済み) かどうか。
  * オリジン・サーバーが、特定のコンテンツの Cache-Control ヘッダーに `max-age` 値を提供するかどうか。 

これらの要素がどのように変わるかに関係なく、オリジンは、ターゲット・コンテンツに対する空でない Cache-Control ヘッダーを提供する必要があります。 オリジンがエッジ・サーバーに対して空でない Cache-Control ヘッダーを提供しない場合、エッジ・サーバーはブラウザーに独自の Cache-Control ヘッダーを提供しません。

エッジ・サーバーが Cache-Control ヘッダーをブラウザーに送信すると、この Cache-Control ヘッダーの `max-age` 値は、エッジ・サーバー上のコンテンツが失効し、オリジンからの再検証が必要になるまでの残り時間に相当します。 

## ヘッダーを尊重 (Respect Header): Off
「ヘッダーを尊重 (Respect Header)」が **Off** に設定されている場合は、CDN の TTL 設定を構成することで、ブラウザー・レベルのキャッシュ時間を制御できます。 ファイルごとまたはファイルのディレクトリーごとに、そのパスおよび必要なキャッシュ期間に関する TTL ルールを作成する必要があります。

このセットアップにより、以下の 2 つのことが実行されます。
  * TTL ルールによって、指定された期間、コンテンツをキャッシュに入れるようにエッジ・サーバーに指示します。
  * コンテンツがエッジ・サーバーから提供される際、エッジ・サーバーが、TTL 期間に基づいた `max-age` 値を含んだ独自の Cache-Control ヘッダーをブラウザーに送信します。

## ヘッダーを尊重 (Respect Header): On
**「ヘッダーを尊重 (Respect Header)」**が **On** に設定される場合は、コンテンツのブラウザー・レベルでのキャッシング時間を制御するために TTL ルールを構成しないことを選択できます。 そうする場合、特定のコンテンツ向けの `max-age` 値を含んだ Cache-Control ヘッダーを提供するように、オリジン・サーバーを構成する必要があります。 「ヘッダーを尊重 (Respect Header)」は On であるため、エッジ・サーバーは、オリジンからの Cache-Control の `max-age` 値を、その特定のコンテンツ向け TTL 期間として使用します。 該当コンテンツをカバーする CDN の TTL ルール・エントリーが既にある場合でも、エッジ・サーバーは、実際には `max-age` 値をそのまま使用し、そのコンテンツ向けに既存のエッジ・レベルのキャッシング期間があっても上書きします。

このセットアップにより、以下の 2 つのことが実行されます。
  * オリジンからの Cache-Control `max-age` ディレクティブの値によって、指定された期間、コンテンツをキャッシュに入れるようにエッジ・サーバーに指示します。
  * コンテンツがエッジ・サーバーから提供される際、エッジ・サーバーが、オリジンからの `max-age` に基づいた `max-age` 値を含んだ独自の Cache-Control ヘッダーをブラウザーに送信します。

例に示されているターゲット設定方式を使用している場合、その TTL ルールによってカバーされるその他のコンテンツは影響を受けません。

**「ヘッダーを尊重 (Respect Header)」**が **On** に設定されていても、オリジン・サーバーが Cache-Control ヘッダー内で `max-age` ディレクティブを送信しない場合、ブラウザーのキャッシング期間は TTL ルールで制御できます。 そこに `max-age` が指定されている場合には、その値が TTL ルールの時間値を誤ってオーバーライドする可能性があります。

## 要約

|ヘッダーを尊重 (Respect Header)|オリジンが Cache-Control を提供|エッジ・サーバー上の特定のコンテンツのキャッシング期間|エッジ・サーバーが Cache-Control を提供|
|---|---|---|---|
|On|はい (`max-age` も指定)|オリジンの `max-age` 値で上書きされる|はい。`max-age` が、エッジのコンテンツがオリジンからの再検証を必要とするまでの時間になる|
|On|はい (`max-age` の指定なし)|CDN の TTL 構成に基づく|はい。`max-age` が、エッジのコンテンツがオリジンからの再検証を必要とするまでの時間になる|
|On|いいえ|CDN の TTL 構成に基づく|いいえ|
|Off|はい (`max-age` も指定)|CDN の TTL 構成に基づく|はい。`max-age` が、エッジのコンテンツがオリジンからの再検証を必要とするまでの時間になる|
|Off|はい (`max-age` の指定なし)|CDN の TTL 構成に基づく|はい。`max-age` が、エッジのコンテンツがオリジンからの再検証を必要とするまでの時間になる|
|Off|いいえ|CDN の TTL 構成に基づく|いいえ|

## 詳細情報
* [CDN の管理](https://console.bluemix.net/docs/infrastructure/CDN/how-to.html)方法
* Cache-Control ([RFC 2616](https://www.ietf.org/rfc/rfc2616.txt) のセクション 14.9 で定義)
